<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GreenRoute â€” Air Quality Map</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }

  #map { width: 100%; height: 100vh; }

  /* â”€â”€ Control panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .panel {
    position: absolute; top: 12px; left: 56px; z-index: 1000;
    background: #fff; border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,.15);
    padding: 14px 18px; min-width: 240px;
    font-size: 13px; color: #333;
  }
  .panel h2 {
    font-size: 15px; font-weight: 700; margin-bottom: 10px;
    display: flex; align-items: center; gap: 6px;
  }
  .panel h2 span { font-size: 18px; }
  .panel label { display: block; margin: 8px 0 3px; font-weight: 600; color: #555; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; }
  .panel select, .panel input[type=range] { width: 100%; }
  .panel select {
    padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px;
    font-size: 13px; background: #fafafa; cursor: pointer;
  }
  .panel select:focus { outline: none; border-color: #4CAF50; }

  /* â”€â”€ Mode toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toggle-group {
    display: flex; gap: 0; margin: 8px 0; border-radius: 6px; overflow: hidden;
    border: 1px solid #ddd;
  }
  .toggle-group button {
    flex: 1; padding: 6px 0; font-size: 12px; font-weight: 600;
    border: none; cursor: pointer; background: #fafafa; color: #555;
    transition: all .15s;
  }
  .toggle-group button.active {
    background: #4CAF50; color: #fff;
  }
  .toggle-group button:hover:not(.active) { background: #eee; }

  /* â”€â”€ Opacity slider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  input[type=range] {
    -webkit-appearance: none; height: 4px; border-radius: 2px;
    background: #ddd; outline: none; margin: 6px 0;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 14px; height: 14px;
    border-radius: 50%; background: #4CAF50; cursor: pointer;
  }

  /* â”€â”€ Stats bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .stats {
    margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;
    font-size: 11px; color: #888; line-height: 1.7;
  }
  .stats strong { color: #333; }

  /* â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .legend {
    position: absolute; bottom: 30px; right: 12px; z-index: 1000;
    background: #fff; border-radius: 10px; padding: 12px 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,.15);
    font-size: 12px;
  }
  .legend h3 { font-size: 12px; font-weight: 700; margin-bottom: 6px; }
  .legend-row {
    display: flex; align-items: center; gap: 8px; margin: 3px 0;
  }
  .legend-swatch {
    width: 18px; height: 12px; border-radius: 3px; flex-shrink: 0;
  }

  /* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .loading {
    position: absolute; top: 50%; left: 50%; z-index: 2000;
    transform: translate(-50%, -50%);
    background: #fff; padding: 16px 28px; border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,.2);
    font-weight: 600; font-size: 14px; color: #333;
    display: none;
  }
  .loading.show { display: block; }

  /* â”€â”€ Layer checkboxes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .layer-toggles {
    margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;
  }
  .layer-toggles label {
    display: flex; align-items: center; gap: 6px;
    font-size: 12px; font-weight: 500; color: #444;
    cursor: pointer; margin: 5px 0; text-transform: none; letter-spacing: 0;
  }
  .layer-toggles input[type=checkbox] {
    accent-color: #4CAF50; width: 14px; height: 14px;
  }

  /* â”€â”€ Refresh indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .refresh-bar {
    margin-top: 8px; font-size: 10px; color: #aaa;
    display: flex; align-items: center; gap: 5px;
  }
  .refresh-dot {
    width: 6px; height: 6px; border-radius: 50%; background: #4CAF50;
    animation: pulse-dot 2s infinite;
  }
  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: .3; }
  }

  /* â”€â”€ Hotspot pulse ring (CSS marker) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .hotspot-pulse {
    width: 24px; height: 24px; position: relative;
  }
  .hotspot-pulse::before {
    content: ''; position: absolute; inset: -6px;
    border-radius: 50%; border: 2px solid;
    animation: hs-ring 1.8s ease-out infinite;
  }
  .hotspot-pulse.moderate { background: #ff7e00; }
  .hotspot-pulse.moderate::before { border-color: #ff7e00; }
  .hotspot-pulse.severe { background: #ff0000; }
  .hotspot-pulse.severe::before { border-color: #ff0000; }
  .hotspot-pulse.critical { background: #7e0023; }
  .hotspot-pulse.critical::before { border-color: #7e0023; }
  @keyframes hs-ring {
    0% { transform: scale(.8); opacity: .8; }
    100% { transform: scale(2.2); opacity: 0; }
  }

  /* â”€â”€ Device popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .device-popup { font-size: 12px; line-height: 1.6; }
  .device-popup .dp-name { font-weight: 700; font-size: 13px; margin-bottom: 4px; }
  .device-popup .dp-row { display: flex; justify-content: space-between; gap: 12px; }
  .device-popup .dp-label { color: #888; }
  .device-popup .dp-val { font-weight: 600; }
  .device-popup .dp-aqi {
    display: inline-block; padding: 1px 8px; border-radius: 4px;
    color: #fff; font-weight: 700; font-size: 11px;
  }

  /* â”€â”€ Hotspot popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .hs-popup { font-size: 12px; line-height: 1.6; }
  .hs-popup .hs-title { font-weight: 700; font-size: 13px; margin-bottom: 4px; color: #d32f2f; }
  .hs-popup .hs-row { display: flex; justify-content: space-between; gap: 12px; }
  .hs-popup .hs-label { color: #888; }
  .hs-popup .hs-val { font-weight: 600; }
</style>
</head>
<body>

<div id="map"></div>

<!-- Control panel -->
<div class="panel">
  <h2><span>ðŸŒ¿</span> GreenRoute Mesh</h2>

  <label>Metric</label>
  <select id="field">
    <option value="aqi_value" selected>Air Quality Index (AQI)</option>
    <option value="pm25_ugm3">PM2.5 (Âµg/mÂ³)</option>
    <option value="temperature_c">Temperature (Â°C)</option>
    <option value="humidity_pct">Humidity (%)</option>
    <option value="co2_ppm">COâ‚‚ (PPM)</option>
    <option value="co_ppm">CO (PPM)</option>
    <option value="heat_index_c">Heat Index (Â°C)</option>
    <option value="toxic_gas_index">Toxic Gas Index</option>
  </select>

  <label>View Mode</label>
  <div class="toggle-group" id="modeToggle">
    <button data-mode="heatmap" class="active">Heatmap</button>
    <button data-mode="contours">Zones</button>
    <button data-mode="points">Points</button>
  </div>

  <label>Opacity <span id="opacityVal">50%</span></label>
  <input type="range" id="opacity" min="10" max="100" value="50">

  <label>Grid Resolution</label>
  <select id="resolution">
    <option value="15">Low (15Ã—15)</option>
    <option value="30">Medium (30Ã—30)</option>
    <option value="50" selected>High (50Ã—50)</option>
    <option value="70">Ultra (70Ã—70)</option>
  </select>

  <div class="stats" id="stats">
    Loading dataâ€¦
  </div>

  <div class="layer-toggles">
    <label><input type="checkbox" id="layerDevices" checked> Devices</label>
    <label><input type="checkbox" id="layerHotspots" checked> Hotspots</label>
    <label><input type="checkbox" id="layerZones" checked> Zone overlay</label>
  </div>

  <div class="refresh-bar">
    <div class="refresh-dot"></div>
    <span id="refreshStatus">Auto-refresh: 60 s</span>
  </div>
</div>

<!-- Legend -->
<div class="legend" id="legend">
  <h3>AQI Scale</h3>
  <div class="legend-row"><div class="legend-swatch" style="background:#00e400"></div> Good (0â€“50)</div>
  <div class="legend-row"><div class="legend-swatch" style="background:#ffff00"></div> Moderate (51â€“100)</div>
  <div class="legend-row"><div class="legend-swatch" style="background:#ff7e00"></div> Sensitive (101â€“150)</div>
  <div class="legend-row"><div class="legend-swatch" style="background:#ff0000"></div> Unhealthy (151â€“200)</div>
  <div class="legend-row"><div class="legend-swatch" style="background:#8f3f97"></div> Very Unhealthy (201â€“300)</div>
  <div class="legend-row"><div class="legend-swatch" style="background:#7e0023"></div> Hazardous (301+)</div>
</div>

<!-- Loading spinner -->
<div class="loading" id="loading">Loading zonesâ€¦</div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_BASE = 'http://localhost:5001';
const DEFAULT_CENTER = [13.05, 80.23];  // Chennai â€” covers all 5 CPCB stations
const DEFAULT_ZOOM = 12;

// Color scales for non-AQI fields
const FIELD_SCALES = {
  aqi_value:       { min: 0,   max: 500,  label: 'AQI',           unit: '',     useAqiColors: true },
  pm25_ugm3:       { min: 0,   max: 150,  label: 'PM2.5',         unit: 'Âµg/mÂ³', colors: ['#00e400','#ffff00','#ff7e00','#ff0000'] },
  temperature_c:   { min: 20,  max: 45,   label: 'Temperature',   unit: 'Â°C',   colors: ['#313695','#4575b4','#74add1','#abd9e9','#fee090','#fdae61','#f46d43','#d73027'] },
  humidity_pct:    { min: 30,  max: 100,  label: 'Humidity',       unit: '%',    colors: ['#fff5eb','#fdd49e','#fdbb84','#fc8d59','#e34a33','#b30000'] },
  co2_ppm:         { min: 400, max: 2000, label: 'COâ‚‚',           unit: 'PPM',  colors: ['#00e400','#ffff00','#ff7e00','#ff0000'] },
  co_ppm:          { min: 0,   max: 50,   label: 'CO',            unit: 'PPM',  colors: ['#00e400','#ffff00','#ff7e00','#ff0000'] },
  heat_index_c:    { min: 25,  max: 50,   label: 'Heat Index',    unit: 'Â°C',   colors: ['#313695','#74add1','#fee090','#fdae61','#f46d43','#d73027'] },
  toxic_gas_index: { min: 0,   max: 100,  label: 'Toxic Gas Idx', unit: '',     colors: ['#00e400','#ffff00','#ff7e00','#ff0000'] },
};

// â”€â”€ Map init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const map = L.map('map', { zoomControl: false }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);

L.control.zoom({ position: 'topright' }).addTo(map);

// Clean base tile (CartoDB light â€” subtle, good for overlays)
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
  maxZoom: 20,
}).addTo(map);

let zoneLayer = null;
let pointLayer = null;
let imageOverlay = null;  // smooth canvas heatmap
let deviceLayer = null;   // device markers
let hotspotLayer = null;  // hotspot circles + pulse markers
let refreshTimer = null;
const REFRESH_INTERVAL = 60;  // seconds
let _refreshCountdown = REFRESH_INTERVAL;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentMode = 'heatmap';
let currentField = 'aqi_value';
let globalOpacity = 0.5;

// â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $field = document.getElementById('field');
const $opacity = document.getElementById('opacity');
const $opacityVal = document.getElementById('opacityVal');
const $resolution = document.getElementById('resolution');
const $stats = document.getElementById('stats');
const $loading = document.getElementById('loading');
const $legend = document.getElementById('legend');
const $layerDevices = document.getElementById('layerDevices');
const $layerHotspots = document.getElementById('layerHotspots');
const $layerZones = document.getElementById('layerZones');
const $refreshStatus = document.getElementById('refreshStatus');

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function valueToColor(value, field) {
  const scale = FIELD_SCALES[field];
  if (!scale) return '#888';
  if (scale.useAqiColors) return aqiColor(value);

  const colors = scale.colors;
  const t = Math.max(0, Math.min(1, (value - scale.min) / (scale.max - scale.min)));
  const idx = t * (colors.length - 1);
  const lo = Math.floor(idx);
  const hi = Math.min(lo + 1, colors.length - 1);
  const frac = idx - lo;
  return lerpColor(colors[lo], colors[hi], frac);
}

function aqiColor(aqi) {
  if (aqi <= 50)  return '#00e400';
  if (aqi <= 100) return '#ffff00';
  if (aqi <= 150) return '#ff7e00';
  if (aqi <= 200) return '#ff0000';
  if (aqi <= 300) return '#8f3f97';
  return '#7e0023';
}

function lerpColor(a, b, t) {
  const ah = parseInt(a.slice(1), 16), bh = parseInt(b.slice(1), 16);
  const ar = (ah >> 16) & 0xff, ag = (ah >> 8) & 0xff, ab = ah & 0xff;
  const br = (bh >> 16) & 0xff, bg = (bh >> 8) & 0xff, bb = bh & 0xff;
  const rr = Math.round(ar + (br - ar) * t);
  const rg = Math.round(ag + (bg - ag) * t);
  const rb = Math.round(ab + (bb - ab) * t);
  return `#${((rr << 16) | (rg << 8) | rb).toString(16).padStart(6, '0')}`;
}

// â”€â”€ Grid smoothing utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** Fill NaN gaps via iterative nearest-neighbour averaging (up to `passes` rounds). */
function fillGridGaps(grid, rows, cols, passes = 3) {
  for (let p = 0; p < passes; p++) {
    let filled = 0;
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        if (!isNaN(grid[r][c])) continue;
        let sum = 0, n = 0;
        for (let dr = -1; dr <= 1; dr++) {
          for (let dc = -1; dc <= 1; dc++) {
            if (dr === 0 && dc === 0) continue;
            const rr = r + dr, cc = c + dc;
            if (rr >= 0 && rr < rows && cc >= 0 && cc < cols && !isNaN(grid[rr][cc])) {
              sum += grid[rr][cc];
              n++;
            }
          }
        }
        if (n >= 2) { grid[r][c] = sum / n; filled++; }
      }
    }
    if (filled === 0) break;
  }
}

/** Apply Gaussian-like 3Ã—3 blur to the grid (in-place, `iterations` times). */
function gaussianBlur(grid, rows, cols, iterations = 2) {
  const kernel = [
    [1, 2, 1],
    [2, 4, 2],
    [1, 2, 1],
  ];
  const kSum = 16;
  for (let iter = 0; iter < iterations; iter++) {
    const tmp = Array.from({ length: rows }, (_, r) => Float32Array.from(grid[r]));
    for (let r = 1; r < rows - 1; r++) {
      for (let c = 1; c < cols - 1; c++) {
        if (isNaN(grid[r][c])) continue;
        let acc = 0, wSum = 0;
        for (let kr = -1; kr <= 1; kr++) {
          for (let kc = -1; kc <= 1; kc++) {
            const v = grid[r + kr][c + kc];
            if (!isNaN(v)) {
              const w = kernel[kr + 1][kc + 1];
              acc += v * w;
              wSum += w;
            }
          }
        }
        tmp[r][c] = acc / wSum;
      }
    }
    for (let r = 0; r < rows; r++) grid[r] = tmp[r];
  }
}

function updateLegend(field) {
  const scale = FIELD_SCALES[field];
  if (!scale) return;

  if (scale.useAqiColors) {
    $legend.innerHTML = `
      <h3>AQI Scale</h3>
      <div class="legend-row"><div class="legend-swatch" style="background:#00e400"></div> Good (0â€“50)</div>
      <div class="legend-row"><div class="legend-swatch" style="background:#ffff00"></div> Moderate (51â€“100)</div>
      <div class="legend-row"><div class="legend-swatch" style="background:#ff7e00"></div> Sensitive (101â€“150)</div>
      <div class="legend-row"><div class="legend-swatch" style="background:#ff0000"></div> Unhealthy (151â€“200)</div>
      <div class="legend-row"><div class="legend-swatch" style="background:#8f3f97"></div> Very Unhealthy (201â€“300)</div>
      <div class="legend-row"><div class="legend-swatch" style="background:#7e0023"></div> Hazardous (301+)</div>
    `;
  } else {
    const steps = 5;
    let html = `<h3>${scale.label}</h3>`;
    for (let i = 0; i <= steps; i++) {
      const val = scale.min + (scale.max - scale.min) * (i / steps);
      const color = valueToColor(val, field);
      html += `<div class="legend-row"><div class="legend-swatch" style="background:${color}"></div> ${Math.round(val)} ${scale.unit}</div>`;
    }
    $legend.innerHTML = html;
  }
}

// â”€â”€ Data fetch + render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadZones() {
  $loading.classList.add('show');

  const res = $resolution.value;
  const url = `${API_BASE}/api/zones?mode=${currentMode}&field=${currentField}&resolution=${res}&radius=500&limit=300`;

  try {
    const resp = await fetch(url);
    const json = await resp.json();

    if (!json.ok) {
      $stats.textContent = 'Error loading data';
      return;
    }

    // Clear old layers
    if (zoneLayer) { map.removeLayer(zoneLayer); zoneLayer = null; }
    if (pointLayer) { map.removeLayer(pointLayer); pointLayer = null; }
    if (imageOverlay) { map.removeLayer(imageOverlay); imageOverlay = null; }

    const geojson = json.geojson;
    if (!geojson || !geojson.features || geojson.features.length === 0) {
      $stats.textContent = 'No zone data available';
      return;
    }

    const meta = geojson.metadata || {};

    if (currentMode === 'points') {
      renderPoints(geojson);
    } else if (currentMode === 'contours') {
      renderContours(geojson);
    } else {
      renderHeatmap(geojson);
    }

    // Fit bounds
    if (meta.bounds) {
      const b = meta.bounds;
      map.fitBounds([[b.lat_min, b.lon_min], [b.lat_max, b.lon_max]], { padding: [40, 40] });
    }

    // Stats
    const scale = FIELD_SCALES[currentField] || {};
    const range = meta.value_range || [];
    $stats.innerHTML = `
      <strong>${meta.point_count || '?'}</strong> sensor points<br>
      <strong>${meta.cell_count || geojson.features.length}</strong> ${currentMode === 'points' ? 'markers' : 'cells/zones'}<br>
      ${range.length ? `<strong>${range[0]}â€“${range[1]}</strong> ${scale.unit || ''}` : ''}
    `;
  } catch (err) {
    console.error('Zone fetch error:', err);
    $stats.textContent = `Error: ${err.message}`;
  } finally {
    $loading.classList.remove('show');
  }
}

function renderHeatmap(geojson) {
  const meta = geojson.metadata || {};
  const bounds = meta.bounds;
  if (!bounds) return;

  const field = currentField;
  const res = meta.grid_resolution || parseInt($resolution.value);
  const features = geojson.features;
  if (!features.length) return;

  // â”€â”€ 1. Build a 2D value grid from the flat feature list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Features are in row-major order (same as numpy output).
  // We'll reconstruct the grid by snapping each cell to its (row, col).
  const latMin = bounds.lat_min, latMax = bounds.lat_max;
  const lonMin = bounds.lon_min, lonMax = bounds.lon_max;
  const dlat = (latMax - latMin) / res;
  const dlon = (lonMax - lonMin) / res;

  // Create NaN-filled grid
  const grid = Array.from({ length: res }, () => new Float32Array(res).fill(NaN));

  for (const f of features) {
    // Cell center from polygon centroid (avg of SW and NE corners)
    const coords = f.geometry.coordinates[0]; // [SW, SE, NE, NW, SW]
    const cLon = (coords[0][0] + coords[2][0]) / 2;
    const cLat = (coords[0][1] + coords[2][1]) / 2;
    const row = Math.round((cLat - latMin - dlat / 2) / dlat);
    const col = Math.round((cLon - lonMin - dlon / 2) / dlon);
    if (row >= 0 && row < res && col >= 0 && col < res) {
      grid[row][col] = f.properties.value;
    }
  }

  // â”€â”€ 2. Fill gaps + Gaussian smooth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  fillGridGaps(grid, res, res, 4);
  gaussianBlur(grid, res, res, 3);

  // â”€â”€ 3. Render to small canvas (grid-size pixels) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const tinyCanvas = document.createElement('canvas');
  tinyCanvas.width = res;
  tinyCanvas.height = res;
  const tinyCtx = tinyCanvas.getContext('2d');
  const imgData = tinyCtx.createImageData(res, res);

  for (let row = 0; row < res; row++) {
    for (let col = 0; col < res; col++) {
      const val = grid[row][col];
      const pxIdx = ((res - 1 - row) * res + col) * 4;  // flip Y (lat increases up)
      if (isNaN(val)) {
        imgData.data[pxIdx + 3] = 0; // transparent
      } else {
        const hex = valueToColor(val, field);
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        imgData.data[pxIdx]     = r;
        imgData.data[pxIdx + 1] = g;
        imgData.data[pxIdx + 2] = b;
        imgData.data[pxIdx + 3] = Math.round(globalOpacity * 200);
      }
    }
  }
  tinyCtx.putImageData(imgData, 0, 0);

  // â”€â”€ 4. Upscale with bilinear smoothing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const upscale = Math.max(16, Math.ceil(800 / res));  // target ~800px
  const bigCanvas = document.createElement('canvas');
  bigCanvas.width = res * upscale;
  bigCanvas.height = res * upscale;
  const bigCtx = bigCanvas.getContext('2d');
  bigCtx.imageSmoothingEnabled = true;
  bigCtx.imageSmoothingQuality = 'high';
  bigCtx.drawImage(tinyCanvas, 0, 0, bigCanvas.width, bigCanvas.height);

  // Extra CSS-level blur for silky transitions
  bigCtx.filter = 'blur(4px)';
  bigCtx.drawImage(bigCanvas, 0, 0);
  bigCtx.filter = 'none';

  // â”€â”€ 5. Overlay on map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const imgBounds = [[latMin, lonMin], [latMax, lonMax]];
  imageOverlay = L.imageOverlay(
    bigCanvas.toDataURL('image/png'),
    imgBounds,
    { opacity: 1, interactive: false }
  ).addTo(map);

  // Also add invisible GeoJSON for click-popups
  zoneLayer = L.geoJSON(geojson, {
    style: () => ({ fillOpacity: 0, weight: 0, opacity: 0 }),
    onEachFeature: (feature, layer) => {
      const p = feature.properties;
      const sc = FIELD_SCALES[field] || {};
      layer.bindPopup(`
        <strong>${sc.label || field}:</strong> ${p.value} ${sc.unit || ''}<br>
        ${p.category ? `<strong>Category:</strong> ${p.category}` : ''}
      `);
    },
  }).addTo(map);
}

function renderContours(geojson) {
  zoneLayer = L.geoJSON(geojson, {
    smoothFactor: 3,
    style: feature => {
      const color = feature.properties.color || '#888';
      return {
        fillColor: color,
        fillOpacity: globalOpacity * 0.55,
        color: color,
        weight: 1.5,
        opacity: globalOpacity * 0.7,
        lineJoin: 'round',
        lineCap: 'round',
      };
    },
    onEachFeature: (feature, layer) => {
      const p = feature.properties;
      layer.bindPopup(`
        <strong>${p.category}</strong><br>
        ${p.cell_count} cells
      `);
    },
  }).addTo(map);
}

function renderPoints(geojson) {
  pointLayer = L.geoJSON(geojson, {
    pointToLayer: (feature, latlng) => {
      const p = feature.properties;
      const color = valueToColor(p.value, currentField);
      return L.circleMarker(latlng, {
        radius: 8,
        fillColor: color,
        fillOpacity: globalOpacity,
        color: '#fff',
        weight: 2,
        opacity: 0.9,
      });
    },
    onEachFeature: (feature, layer) => {
      const p = feature.properties;
      const scale = FIELD_SCALES[currentField] || {};
      layer.bindPopup(`
        <strong>${scale.label || currentField}:</strong> ${p.value} ${scale.unit || ''}<br>
        ${p.category ? `<strong>Category:</strong> ${p.category}` : ''}
      `);
    },
  }).addTo(map);
}

// â”€â”€ Event listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$field.addEventListener('change', () => {
  currentField = $field.value;
  updateLegend(currentField);
  loadZones();
});

// â”€â”€ Debounce helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _opacityTimer = null;

$opacity.addEventListener('input', () => {
  globalOpacity = $opacity.value / 100;
  $opacityVal.textContent = `${$opacity.value}%`;

  if (currentMode === 'heatmap') {
    // Canvas heatmap â€” debounce re-render to update alpha
    clearTimeout(_opacityTimer);
    _opacityTimer = setTimeout(() => loadZones(), 150);
    return;
  }
  // GeoJSON layers â€” re-style without refetch
  if (zoneLayer) {
    zoneLayer.eachLayer(layer => {
      if (layer.setStyle) {
        layer.setStyle({ fillOpacity: globalOpacity * 0.6, opacity: globalOpacity * 0.8 });
      }
    });
  }
  if (pointLayer) {
    pointLayer.eachLayer(layer => {
      if (layer.setStyle) layer.setStyle({ fillOpacity: globalOpacity });
    });
  }
});

$resolution.addEventListener('change', () => loadZones());

// Mode toggle buttons
document.querySelectorAll('#modeToggle button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#modeToggle button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentMode = btn.dataset.mode;
    loadZones();
  });
});

// â”€â”€ Initial load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€ Device markers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function deviceAqiColor(aqi) {
  if (aqi == null) return '#888';
  if (aqi <= 50)  return '#00e400';
  if (aqi <= 100) return '#ffff00';
  if (aqi <= 150) return '#ff7e00';
  if (aqi <= 200) return '#ff0000';
  if (aqi <= 300) return '#8f3f97';
  return '#7e0023';
}

async function loadDevices() {
  if (!$layerDevices.checked) {
    if (deviceLayer) { map.removeLayer(deviceLayer); deviceLayer = null; }
    return;
  }
  try {
    const resp = await fetch(`${API_BASE}/api/devices`);
    const json = await resp.json();
    if (!json.ok) return;

    if (deviceLayer) { map.removeLayer(deviceLayer); deviceLayer = null; }
    deviceLayer = L.layerGroup();

    for (const d of json.devices) {
      const dev = d.device || {};
      const rd  = d.latest_reading || {};
      const lat = rd.latitude || dev.static_latitude;
      const lon = rd.longitude || dev.static_longitude;
      if (!lat || !lon) continue;

      const aqi  = rd.aqi_value;
      const cat  = rd.aqi_category || 'â€”';
      const name = dev.name || dev.device_id;
      const color = deviceAqiColor(aqi);

      const marker = L.circleMarker([lat, lon], {
        radius: 10,
        fillColor: color,
        fillOpacity: 0.9,
        color: '#fff',
        weight: 2.5,
        opacity: 1,
      });

      marker.bindPopup(`
        <div class="device-popup">
          <div class="dp-name">${name}</div>
          <div class="dp-row"><span class="dp-label">Device ID</span><span class="dp-val">${dev.device_id}</span></div>
          ${aqi != null ? `<div class="dp-row"><span class="dp-label">AQI</span><span class="dp-aqi" style="background:${color}">${aqi} ${cat}</span></div>` : ''}
          ${rd.pm25_ugm3 != null ? `<div class="dp-row"><span class="dp-label">PM2.5</span><span class="dp-val">${rd.pm25_ugm3} Âµg/mÂ³</span></div>` : ''}
          ${rd.temperature_c != null ? `<div class="dp-row"><span class="dp-label">Temp</span><span class="dp-val">${rd.temperature_c}Â°C</span></div>` : ''}
          ${rd.humidity_pct != null ? `<div class="dp-row"><span class="dp-label">Humidity</span><span class="dp-val">${rd.humidity_pct}%</span></div>` : ''}
          ${rd.co_ppm != null ? `<div class="dp-row"><span class="dp-label">CO</span><span class="dp-val">${rd.co_ppm} ppm</span></div>` : ''}
          ${rd.heat_index_c != null ? `<div class="dp-row"><span class="dp-label">Heat Index</span><span class="dp-val">${rd.heat_index_c}Â°C</span></div>` : ''}
          ${rd.respiratory_risk_label ? `<div class="dp-row"><span class="dp-label">Risk</span><span class="dp-val">${rd.respiratory_risk_label}</span></div>` : ''}
          <div class="dp-row"><span class="dp-label">Status</span><span class="dp-val">${dev.status || 'â€”'}</span></div>
        </div>
      `, { maxWidth: 280 });

      // Tooltip on hover
      marker.bindTooltip(name, { direction: 'top', offset: [0, -10], className: 'device-tooltip' });

      marker.addTo(deviceLayer);
    }
    deviceLayer.addTo(map);
  } catch (err) {
    console.error('Device load error:', err);
  }
}

// â”€â”€ Hotspot overlays â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function hotspotColor(severity) {
  switch ((severity || '').toLowerCase()) {
    case 'critical': return '#7e0023';
    case 'severe':   return '#ff0000';
    default:         return '#ff7e00'; // moderate
  }
}

async function loadHotspots() {
  if (!$layerHotspots.checked) {
    if (hotspotLayer) { map.removeLayer(hotspotLayer); hotspotLayer = null; }
    return;
  }
  try {
    const resp = await fetch(`${API_BASE}/api/hotspots/active`);
    const json = await resp.json();
    if (!json.ok) return;

    if (hotspotLayer) { map.removeLayer(hotspotLayer); hotspotLayer = null; }
    hotspotLayer = L.layerGroup();

    for (const h of json.hotspots) {
      if (!h.latitude || !h.longitude) continue;
      const color = hotspotColor(h.severity_level);
      const radiusM = h.radius_m || 500;

      // Translucent influence circle
      const circle = L.circle([h.latitude, h.longitude], {
        radius: radiusM,
        color: color,
        weight: 2,
        opacity: 0.6,
        fillColor: color,
        fillOpacity: 0.15,
        dashArray: '6 4',
      });

      // Pulsing center marker
      const sevClass = (h.severity_level || 'moderate').toLowerCase();
      const pulseIcon = L.divIcon({
        className: '',
        html: `<div class="hotspot-pulse ${sevClass}" style="border-radius:50%;width:18px;height:18px;"></div>`,
        iconSize: [18, 18],
        iconAnchor: [9, 9],
      });
      const centerMarker = L.marker([h.latitude, h.longitude], { icon: pulseIcon });

      const popupHtml = `
        <div class="hs-popup">
          <div class="hs-title">âš  Hotspot â€” ${h.severity_level || 'unknown'}</div>
          <div class="hs-row"><span class="hs-label">Pollutant</span><span class="hs-val">${h.primary_pollutant}</span></div>
          <div class="hs-row"><span class="hs-label">Peak AQI</span><span class="hs-val">${h.peak_aqi}</span></div>
          <div class="hs-row"><span class="hs-label">Peak Value</span><span class="hs-val">${h.peak_value} Âµg/mÂ³</span></div>
          <div class="hs-row"><span class="hs-label">Readings</span><span class="hs-val">${h.contributing_readings}</span></div>
          <div class="hs-row"><span class="hs-label">Radius</span><span class="hs-val">${radiusM} m</span></div>
          ${h.location ? `<div class="hs-row"><span class="hs-label">Location</span><span class="hs-val">${h.location}</span></div>` : ''}
          <div class="hs-row"><span class="hs-label">First detected</span><span class="hs-val">${(h.first_detected_at || '').slice(0, 16)}</span></div>
        </div>
      `;
      circle.bindPopup(popupHtml, { maxWidth: 280 });
      centerMarker.bindPopup(popupHtml, { maxWidth: 280 });

      circle.addTo(hotspotLayer);
      centerMarker.addTo(hotspotLayer);
    }
    hotspotLayer.addTo(map);
  } catch (err) {
    console.error('Hotspot load error:', err);
  }
}

// â”€â”€ Zone layer toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function clearZoneLayers() {
  if (zoneLayer)    { map.removeLayer(zoneLayer);    zoneLayer = null; }
  if (pointLayer)   { map.removeLayer(pointLayer);   pointLayer = null; }
  if (imageOverlay) { map.removeLayer(imageOverlay); imageOverlay = null; }
}

// â”€â”€ Master refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function refreshAll() {
  await Promise.all([
    $layerZones.checked ? loadZones() : Promise.resolve(clearZoneLayers()),
    loadDevices(),
    loadHotspots(),
  ]);
  _refreshCountdown = REFRESH_INTERVAL;
}

// â”€â”€ Auto-refresh countdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function startAutoRefresh() {
  if (refreshTimer) clearInterval(refreshTimer);
  _refreshCountdown = REFRESH_INTERVAL;
  refreshTimer = setInterval(() => {
    _refreshCountdown--;
    $refreshStatus.textContent = `Auto-refresh: ${_refreshCountdown}s`;
    if (_refreshCountdown <= 0) {
      refreshAll();
    }
  }, 1000);
}

// â”€â”€ Layer toggle listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

$layerDevices.addEventListener('change', loadDevices);
$layerHotspots.addEventListener('change', loadHotspots);
$layerZones.addEventListener('change', () => {
  if ($layerZones.checked) loadZones();
  else clearZoneLayers();
});

updateLegend(currentField);
refreshAll();
startAutoRefresh();
</script>
</body>
</html>
